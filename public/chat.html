<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mya Chat - virtueism.org</title>
  <style>
    body, html {
      margin: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #343541;
      color: #fff;
    }
    #app { display: flex; height: 100vh; }
    #sidebar {
      width: 220px;
      background: #202123;
      display: flex;
      flex-direction: column;
    }
    #sidebar header {
      padding: 1rem;
      border-bottom: 1px solid #333;
    }
    #sidebar header button {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      background: #4e83ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #conv-list { flex: 1; overflow-y: auto; list-style: none; margin: 0; padding: 0; }
    #conv-list li { padding: 0.5rem 1rem; cursor: pointer; display: flex; align-items: center; }
    #conv-list li.active { background: #2a2b32; }
    #conv-list li span { flex: 1; }
    #conv-list li button { background: none; border: none; color: #fff; margin-left: 4px; cursor: pointer; }
    #sidebar footer {
      padding: 1rem;
      border-top: 1px solid #333;
      font-size: 0.9rem;
    }
    #chat-area { flex: 1; display: flex; flex-direction: column; }
    #chat-container { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; }
    .msg { padding: 0.75rem 1rem; border-radius: 6px; margin-bottom: 1rem; max-width: 80%; word-wrap: break-word; }
    .user { align-self: flex-end; background: #40414f; }
    .assistant { align-self: flex-start; background: #3c3c3c; }
    #chatForm { display: flex; padding: 1rem; background: #202123; }
    #msg { flex: 1; padding: 0.5rem; border-radius: 4px; border: none; }
    #chatForm button { margin-left: 0.5rem; padding: 0.5rem 1rem; border: none; border-radius: 4px; background: #4e83ff; color: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <div id="app">
    <div id="sidebar">
      <header>
        <button id="new-chat">+ New Chat</button>
        <button id="export-chat">Export</button>
      </header>
      <ul id="conv-list"></ul>
      <footer>
        <div id="credits">Credits: ...</div>
        <div><a href="/preferences" style="color:#fff">Preferences</a></div>
        <div><a href="/logout" style="color:#fff">Logout</a></div>
      </footer>
    </div>
    <div id="chat-area">
      <div id="chat-container"></div>
      <form id="chatForm">
        <input type="text" id="msg" autocomplete="off" placeholder="Talk to Mya..." required />
        <button type="submit">Send</button>
      </form>
    </div>
  </div>
<script>
const form = document.getElementById('chatForm');
const container = document.getElementById('chat-container');
const list = document.getElementById('conv-list');
let conversations = JSON.parse(localStorage.getItem('conversations') || '[]');
let currentId = conversations[0]?.id || null;

function save() { localStorage.setItem('conversations', JSON.stringify(conversations)); }

function append(role, text) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.textContent = text;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  const conv = conversations.find(c => c.id === currentId);
  if (conv) { conv.messages.push({role, text}); save(); }
}

function renderConversations() {
  list.innerHTML = '';
  conversations.forEach(c => {
    const li = document.createElement('li');
    li.className = c.id === currentId ? 'active' : '';
    const span = document.createElement('span');
    span.textContent = c.name;
    span.oncontextmenu = (e) => {
      e.preventDefault();
      const n = prompt('Rename chat', c.name);
      if (n) { c.name = n; save(); renderConversations(); }
    };
    li.appendChild(span);
    const del = document.createElement('button');
    del.textContent = 'ðŸ—‘';
    del.onclick = (e) => {
      e.stopPropagation();
      conversations = conversations.filter(x => x.id !== c.id);
      if (currentId === c.id) { currentId = conversations[0]?.id || null; }
      save();
      renderConversations();
      loadConversation();
    };
    li.appendChild(del);
    li.onclick = () => { currentId = c.id; renderConversations(); loadConversation(); };
    list.appendChild(li);
  });
}

function loadConversation() {
  container.innerHTML = '';
  const conv = conversations.find(c => c.id === currentId);
  if (conv) conv.messages.forEach(m => append(m.role, m.text));
}

function newChat() {
  const id = Date.now().toString();
  conversations.unshift({ id, name: 'New Chat', messages: [] });
  currentId = id;
  save();
  renderConversations();
  loadConversation();
}

document.getElementById('new-chat').onclick = newChat;
document.getElementById('export-chat').onclick = () => {
  const conv = conversations.find(c => c.id === currentId);
  if (!conv) return;
  const lines = conv.messages.map(m => `${m.role}: ${m.text}`);
  const blob = new Blob([lines.join('\n')], {type: 'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (conv.name || 'chat') + '.txt';
  a.click();
  URL.revokeObjectURL(a.href);
};

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const input = document.getElementById('msg');
  const text = input.value.trim();
  if(!text) return;
  append('user', text);
  input.value = '';
  const res = await fetch('/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: text })
  });
  const data = await res.json();
  append('assistant', data.reply);
});

async function loadCredits() {
  const res = await fetch('/credits');
  const data = await res.json();
  document.getElementById('credits').textContent = 'Credits: ' + data.credits;
}
loadCredits();
renderConversations();
loadConversation();
</script>
</body>
</html>
